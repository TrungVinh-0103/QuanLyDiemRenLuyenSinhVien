@model List<QLDiemRenLuyen.Models.PhieuDanhGia>
@{
    ViewData["Title"] = "Quản lý Phiếu đánh giá";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var nienKhoas = ViewBag.NienKhoas as List<QLDiemRenLuyen.Models.NienKhoa> ?? new List<QLDiemRenLuyen.Models.NienKhoa>();
    var khoas = ViewBag.Khoas as List<QLDiemRenLuyen.Models.Khoa> ?? new List<QLDiemRenLuyen.Models.Khoa>();
    var hocKys = ViewBag.HocKys as List<QLDiemRenLuyen.Models.HocKy> ?? new List<QLDiemRenLuyen.Models.HocKy>();
    var lopList = ViewBag.Lops as List<QLDiemRenLuyen.Models.Lop> ?? new List<QLDiemRenLuyen.Models.Lop>();
    var trangThai = ViewBag.TrangThai as List<QLDiemRenLuyen.Models.CauHinh.CauHinhTrangThaiSinhVien> ?? new List<QLDiemRenLuyen.Models.CauHinh.CauHinhTrangThaiSinhVien>();
    var uniqueNamHocs = hocKys.Select(hk => hk.NamHoc).Distinct().OrderBy(nh => nh).ToList(); // Lấy danh sách năm học duy nhất
}
<link rel="stylesheet" href="~/css/QuanLyPhieuDanhGia.css">

<div class="admin-container">
    <div class="container-fluid">
        <div class="content-card">
            <h1 class="page-title">
                <i class="fas fa-clipboard-list me-2"></i>
                Quản Lý Phiếu Đánh Giá
            </h1>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count ?? 0)</div>
                        <div class="text-muted">Tổng phiếu</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count(x => x.TongDiemTuDanhGia.HasValue) ?? 0)</div>
                        <div class="text-muted">Đã tự đánh giá</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count(x => x.TongDiemGiaoVienDeXuat.HasValue) ?? 0)</div>
                        <div class="text-muted">GV đã đề xuất</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count(x => x.TongDiemHoiDongDuyet.HasValue) ?? 0)</div>
                        <div class="text-muted">HĐ đã duyệt</div>
                    </div>
                </div>
            </div>

            @if (TempData["Loi"] != null)
            {
                <div class="alert alert-danger-modern alert-modern">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["Loi"]
                </div>
            }
            @if (TempData["ThanhCong"] != null)
            {
                <div class="alert alert-success-modern alert-modern">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["ThanhCong"]
                </div>
            }
            @if (ViewBag.KhongTimThay != null)
            {
                <div class="alert alert-warning-modern alert-modern">
                    <i class="fas fa-info-circle me-2"></i>
                    @ViewBag.KhongTimThay
                </div>
            }

            <div class="filter-card">
                <form method="get" asp-action="QuanLyPhieuDanhGia" class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Năm học
                        </label>
                        <select name="NamHoc" class="form-select modern-form-control">
                            <option value="">-- Chọn năm học --</option>
                            @foreach (var namHoc in uniqueNamHocs)
                            {
                                <option value="@namHoc" selected="@(namHoc == (string?)ViewBag.NamHoc ? "selected" : null)">@namHoc</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-university me-1"></i>
                            Khoa
                        </label>
                        <select name="KhoaID" class="form-select modern-form-control">
                            <option value="">-- Chọn khoa --</option>
                            @foreach (var khoa in khoas)
                            {
                                <option value="@khoa.KhoaID" selected="@(khoa.KhoaID == (int?)ViewBag.KhoaID ? "selected" : null)">@khoa.TenKhoa</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-book me-1"></i>
                            Học kỳ
                        </label>
                        <select name="HocKyID" class="form-select modern-form-control">
                            <option value="">-- Chọn học kỳ --</option>
                            @foreach (var hk in hocKys)
                            {
                                <option value="@hk.HocKyID" selected="@(hk.HocKyID == (int?)ViewBag.HocKyID ? "selected" : null)">@hk.TenHocKy - @hk.NamHoc</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-users me-1"></i>
                            Lớp
                        </label>
                        <select name="LopID" class="form-select modern-form-control">
                            <option value="">-- Chọn lớp --</option>
                            @foreach (var lop in lopList)
                            {
                                <option value="@lop.LopID" selected="@(lop.LopID == (int?)ViewBag.LopID ? "selected" : null)">@lop.TenLop</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold text-success">
                            <i class="fas fa-id-card me-1"></i>
                            Mã SV
                        </label>
                        <input type="text" name="MaSV" class="form-control modern-form-control" placeholder="Nhập mã SV" value="@ViewBag.MaSV" />
                    </div>
                    <div class="col-md-2 align-self-end">
                        <button type="submit" class="btn modern-btn btn-filter w-100">
                            <i class="fas fa-search me-2"></i>
                            Lọc
                        </button>
                    </div>
                </form>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-warning text-center" style="border-radius: 15px; padding: 2rem;">
                    <i class="fas fa-clipboard-list fa-3x mb-3 text-muted"></i>
                    <h5>Không có phiếu đánh giá nào</h5>
                    <p>Không tìm thấy dữ liệu phù hợp với bộ lọc</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table modern-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Sinh viên</th>
                                <th>Lớp</th>
                                <th>Học kỳ</th>
                                <th>Ngày tạo</th>
                                <th>Trạng thái</th>
                                <th>Điểm SV</th>
                                <th>Điểm GV</th>
                                <th>Điểm HĐ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Count > 0)
                            {
                                int stt = 1;
                                foreach (var p in Model)
                                {
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary rounded-pill">@(stt++)</span>
                                        </td>
                                        <td>
                                            <div class="badge-student">
                                                <strong>@p.SinhVien?.HoTen</strong><br>
                                                <small>(@p.SinhVien?.MaSV)</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge-class">@p.SinhVien?.Lop?.TenLop</span>
                                        </td>
                                        <td>
                                            <small>
                                                @p.HocKy?.TenHocKy - @p.HocKy?.NamHoc<br>
                                                <em>NK: @p.HocKy?.NienKhoa?.TenNienKhoa</em>
                                            </small>
                                        </td>
                                        <td>
                                            <small>@p.NgayLapPhieu.ToString("dd/MM/yyyy")</small>
                                        </td>
                                        <td>
                                            <span class="badge-status">@p.TrangThaiDanhGia?.TenTrangThai</span>
                                        </td>
                                        <td>
                                            <span class="badge-score">@(p.TongDiemTuDanhGia?.ToString() ?? "N/A")</span>
                                        </td>
                                        <td>
                                            <span class="badge-score">@(p.TongDiemGiaoVienDeXuat?.ToString() ?? "N/A")</span>
                                        </td>
                                        <td>
                                            <span class="badge-score">@(p.TongDiemHoiDongDuyet?.ToString() ?? "N/A")</span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="modern-btn btn-info-modern"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalChiTietPhieu_@p.PhieuDanhGiaID"
                                                        title="Chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <form asp-action="XoaPhieuDanhGia" method="post" class="d-inline">
                                                    <input type="hidden" name="id" value="@p.PhieuDanhGiaID" />
                                                    <button class="modern-btn btn-delete"
                                                            onclick="return confirm('Xác nhận xóa phiếu này?')"
                                                            title="Xóa">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (Model != null)
{
    @foreach (var item in Model)
    {
        <div class="modal fade modern-modal" id="modalChiTietPhieu_@item.PhieuDanhGiaID" tabindex="-1" aria-labelledby="chiTietPhieuLabel_@item.PhieuDanhGiaID" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle me-2"></i>
                            Chi tiết phiếu đánh giá - @(item.SinhVien?.HoTen ?? "N/A")
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong><i class="fas fa-user me-2"></i>Sinh viên:</strong> @(item.SinhVien?.HoTen ?? "N/A") (@(item.SinhVien?.MaSV ?? "N/A"))</p>
                                <p><strong><i class="fas fa-users me-2"></i>Lớp:</strong> @(item.SinhVien?.Lop?.TenLop ?? "N/A")</p>
                                <p><strong><i class="fas fa-university me-2"></i>Khoa:</strong> @(item.SinhVien?.Lop?.Khoa?.TenKhoa ?? "N/A")</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong><i class="fas fa-book me-2"></i>Học kỳ:</strong> @(item.HocKy?.TenHocKy ?? "N/A") - @(item.HocKy?.NamHoc ?? "N/A")</p>
                                <p><strong><i class="fas fa-calendar me-2"></i>Ngày tạo:</strong> @item.NgayLapPhieu.ToString("dd/MM/yyyy")</p>
                                <p><strong><i class="fas fa-info-circle me-2"></i>Trạng thái:</strong> @(item.TrangThaiDanhGia?.TenTrangThai ?? "Chưa xác định")</p>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stats-card" style="background: linear-gradient(135deg, #74b9ff, #0984e3); color: white;">
                                    <div class="stats-number" style="color: white;">@(item.TongDiemTuDanhGia?.ToString() ?? "N/A")</div>
                                    <div style="color: rgba(255,255,255,0.8);">Điểm tự đánh giá</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card" style="background: linear-gradient(135deg, #fdcb6e, #e17055); color: white;">
                                    <div class="stats-number" style="color: white;">@(item.TongDiemGiaoVienDeXuat?.ToString() ?? "N/A")</div>
                                    <div style="color: rgba(255,255,255,0.8);">Điểm GV đề xuất</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card" style="background: linear-gradient(135deg, #00b894, #00a085); color: white;">
                                    <div class="stats-number" style="color: white;">@(item.TongDiemHoiDongDuyet?.ToString() ?? "N/A")</div>
                                    <div style="color: rgba(255,255,255,0.8);">Điểm HĐ duyệt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border: none; padding: 1.5rem;">
                        <button type="button" class="modern-btn" style="background: #6c757d; color: white;" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Đóng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert-modern').fadeOut();
        }, 5000);

        // Animation for table rows
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('.modern-table tbody tr');
            rows.forEach((row, index) => {
                row.style.animationDelay = `${index * 0.1}s`;
                row.style.animation = 'fadeInUp 0.6s ease forwards';
            });
        });

        // Enhanced modal interactions
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                const targetModal = document.querySelector(this.getAttribute('data-bs-target'));
                if (targetModal) {
                    targetModal.classList.add('animate__animated', 'animate__zoomIn');
                }
            });
        });
    </script>
}