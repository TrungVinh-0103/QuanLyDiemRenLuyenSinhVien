@model List<QLDiemRenLuyen.Models.SinhVien>
@{
    ViewData["Title"] = "Quản lý Sinh viên";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var khoas = ViewBag.Khoas as List<QLDiemRenLuyen.Models.Khoa> ?? new List<QLDiemRenLuyen.Models.Khoa>();
    var lops = ViewBag.Lops as List<QLDiemRenLuyen.Models.Lop> ?? new List<QLDiemRenLuyen.Models.Lop>();
    var trangThais = ViewBag.TrangThaiSinhVien as List<QLDiemRenLuyen.Models.CauHinh.CauHinhTrangThaiSinhVien> ?? new List<QLDiemRenLuyen.Models.CauHinh.CauHinhTrangThaiSinhVien>();
}

<div class="container mt-4">
    <h4 class="text-primary mb-3">QUẢN LÝ SINH VIÊN</h4>

    @if (TempData["ThanhCong"] != null)
    {
        <div class="alert alert-success">@TempData["ThanhCong"]</div>
    }
    @if (TempData["Loi"] != null)
    {
        <div class="alert alert-danger">@TempData["Loi"]</div>
    }

    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalThem">+ Thêm Sinh viên</button>

    @if (!Model.Any())
    {
        <div class="alert alert-warning">Không có sinh viên nào để hiển thị.</div>
    }
    else
    {
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>MSSV</th>
                    <th>Họ tên</th>
                    <th>Giới tính</th>
                    <th>Ngày sinh</th>
                    <th>Nơi sinh</th>
                    <th>Lớp</th>
                    <th>Khoa</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sv in Model)
                {
                    <tr>
                        <td>@sv.MaSV</td>
                        <td>@sv.HoTen</td>
                        <td>@sv.GioiTinh</td>
                        <td>@(sv.NgaySinh?.ToString("dd/MM/yyyy"))</td>
                        <td>@sv.NoiSinh</td>
                        <td>@sv.Lop?.TenLop</td>
                        <td>@sv.Khoa?.TenKhoa</td>
                        <td>@sv.TrangThai?.TenTrangThai</td>
                        <td>
                            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalSua_@sv.SinhVienID">Sửa</button>
                            <form asp-action="XoaSinhVien" asp-controller="Admin" method="post" style="display:inline;" onsubmit="return confirm('Xác nhận xóa sinh viên này\u003F');">
                                <input type="hidden" name="id" value="@sv.SinhVienID" />
                                <button type="submit" class="btn btn-sm btn-danger">Xóa</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- Modal Sửa -->
    @foreach (var sv in Model)
    {
        <div class="modal fade" id="modalSua_@sv.SinhVienID" tabindex="-1" aria-labelledby="modalSuaLabel_@sv.SinhVienID" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form asp-action="SuaSinhVien" asp-controller="Admin" method="post">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title" id="modalSuaLabel_@sv.SinhVienID">Sửa sinh viên: @sv.HoTen</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body row">
                            <input type="hidden" name="SinhVienID" value="@sv.SinhVienID" />
                            <div class="col-md-6 mb-3">
                                <label class="form-label">MSSV</label>
                                <input name="MaSV" class="form-control" value="@sv.MaSV" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Họ tên</label>
                                <input name="HoTen" class="form-control" value="@sv.HoTen" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Giới tính</label>
                                <select name="GioiTinh" class="form-control" required>
                                    @if (sv.GioiTinh == "Nam")
                                    {
                                        <option value="Nam" selected>Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    }
                                    else
                                    {
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ" selected>Nữ</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày sinh</label>
                                <input type="date" name="NgaySinh" class="form-control" value="@sv.NgaySinh?.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nơi sinh</label>
                                <input name="NoiSinh" class="form-control" value="@sv.NoiSinh" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Khoa</label>
                                <select name="KhoaID" class="form-control" required>
                                    @foreach (var k in khoas)
                                    {
                                        if (k.KhoaID == sv.KhoaID)
                                        {
                                            <option value="@k.KhoaID" selected>@k.TenKhoa</option>
                                        }
                                        else
                                        {
                                            <option value="@k.KhoaID">@k.TenKhoa</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Lớp</label>
                                <select name="LopID" class="form-control" required>
                                    @foreach (var l in lops)
                                    {
                                        if (l.LopID == sv.LopID)
                                        {
                                            <option value="@l.LopID" selected>@l.TenLop</option>
                                        }
                                        else
                                        {
                                            <option value="@l.LopID">@l.TenLop</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Trạng thái</label>
                                <select name="TrangThaiID" class="form-control" required>
                                    @foreach (var t in trangThais)
                                    {
                                        if (t.TrangThaiID == sv.TrangThaiID)
                                        {
                                            <option value="@t.TrangThaiID" selected>@t.TenTrangThai</option>
                                        }
                                        else
                                        {
                                            <option value="@t.TrangThaiID">@t.TenTrangThai</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Lưu</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }

    <!-- Modal Thêm -->
    <div class="modal fade" id="modalThem" tabindex="-1" aria-labelledby="modalThemLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-action="ThemSinhVien" asp-controller="Admin" method="post">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="modalThemLabel">Thêm Sinh viên</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">MSSV</label>
                            <input name="MaSV" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Họ tên</label>
                            <input name="HoTen" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giới tính</label>
                            <select name="GioiTinh" class="form-control" required>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" name="NgaySinh" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nơi sinh</label>
                            <input name="NoiSinh" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Khoa</label>
                            <select name="KhoaID" class="form-control" required>
                                @foreach (var k in khoas)
                                {
                                    <option value="@k.KhoaID">@k.TenKhoa</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lớp</label>
                            <select name="LopID" class="form-control" required>
                                @foreach (var l in lops)
                                {
                                    <option value="@l.LopID">@l.TenLop</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trạng thái</label>
                            <select name="TrangThaiID" class="form-control" required>
                                @foreach (var t in trangThais)
                                {
                                    <option value="@t.TrangThaiID">@t.TenTrangThai</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', () => {
                console.log('Modal button clicked: ', button.getAttribute('data-bs-target'));
            });
        });
    </script>
}