@model List<TieuChi>
@{
    ViewData["Title"] = "Quản lý Tiêu chí";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var nhoms = ViewBag.NhomTieuChiList as List<NhomTieuChi> ?? new();
}
<link rel="stylesheet" href="/css/QuanLyTieuChi.css" />

<div class="admin-container">
    <div class="container-fluid">
        <div class="content-card">
            <h1 class="page-title">
                <i class="fas fa-tasks me-2"></i>
                Quản Lý Tiêu Chí
            </h1>

            <div class="row mb-2 d-flex justify-content-between">
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count ?? 0)</div>
                        <div class="text-muted">Tổng tiêu chí</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="stats-number">@(nhoms?.Count ?? 0)</div>
                        <div class="text-muted">Nhóm tiêu chí</div>
                    </div>
                </div>
            </div>

            @if (TempData["Loi"] != null)
            {
                <div class="alert alert-danger-modern alert-modern">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["Loi"]
                </div>
            }
            @if (TempData["ThanhCong"] != null)
            {
                <div class="alert alert-success-modern alert-modern">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["ThanhCong"]
                </div>
            }

            <div class="card mb-4" style="border: none; border-radius: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 15px 15px 0 0;">
                    <h6 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        Thêm Tiêu Chí Mới
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="ThemTieuChi" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-layer-group me-2"></i>
                                Nhóm tiêu chí
                            </label>
                            <select name="NhomTieuChiID" class="form-select modern-form-control" required>
                                <option value="">-- Chọn nhóm --</option>
                                @if (nhoms != null)
                                    @foreach (var n in nhoms)
                                    {
                                        <option value="@n.NhomTieuChiID">@n.TenNhom</option>
                                    }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-tag me-2"></i>
                                Tên tiêu chí
                            </label>
                            <input name="TenTieuChi" class="form-control modern-form-control" placeholder="Nhập tên tiêu chí" required />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">
                                <i class="fas fa-star me-2"></i>
                                Điểm tối đa
                            </label>
                            <input name="DiemToiDa" type="number" class="form-control modern-form-control" placeholder="Điểm" required />
                        </div>
                        <div class="col-md-2 align-self-end">
                            <button class="btn modern-btn btn-add w-100">
                                <i class="fas fa-plus me-2"></i>
                                Thêm
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-warning text-center" style="border-radius: 15px; padding: 2rem;">
                    <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                    <h5>Chưa có tiêu chí nào</h5>
                    <p>Hãy thêm tiêu chí đầu tiên bằng form bên trên</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table modern-table">
                        <thead>
                            <tr>
                                <th>
                                    <i class="fas fa-hashtag me-2"></i>
                                    STT
                                </th>
                                <th>
                                    <i class="fas fa-layer-group me-2"></i>
                                    Nhóm
                                </th>
                                <th>
                                    <i class="fas fa-tag me-2"></i>
                                    Tiêu chí
                                </th>
                                <th>
                                    <i class="fas fa-star me-2"></i>
                                    Điểm tối đa
                                </th>
                                <th>
                                    <i class="fas fa-cogs me-2"></i>
                                    Thao tác
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var tc = Model[i];
                                <tr>
                                    <td>
                                        <span class="badge bg-primary rounded-pill">@(i + 1)</span>
                                    </td>
                                    <td>
                                        <span class="badge-group">@tc.NhomTieuChi?.TenNhom</span>
                                    </td>
                                    <td>
                                        <strong>@tc.TenTieuChi</strong>
                                    </td>
                                    <td>
                                        <span class="badge-score">@tc.DiemToiDa</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="modern-btn btn-edit"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalSua_@tc.TieuChiID"
                                                    title="Sửa">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <a href="/Admin/XoaTieuChi/@tc.TieuChiID"
                                               class="modern-btn btn-delete"
                                               onclick="return confirm('Xác nhận xóa tiêu chí này?')"
                                               title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@if (Model != null)
{
    @foreach (var tc in Model)
    {
        <div class="modal fade modern-modal" id="modalSua_@tc.TieuChiID" tabindex="-1" aria-labelledby="modalLabel_@tc.TieuChiID" aria-hidden="true">
            <div class="modal-dialog">
                <form method="post" asp-action="SuaTieuChi" class="modal-content">
                    <input type="hidden" name="TieuChiID" value="@tc.TieuChiID" />
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel_@tc.TieuChiID">
                            <i class="fas fa-edit me-2"></i>
                            Sửa tiêu chí
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-layer-group me-2"></i>
                                Nhóm tiêu chí
                            </label>
                            <select name="NhomTieuChiID" class="form-select modern-form-control">
                                @if (nhoms != null)
                                    @foreach (var n in nhoms)
                                    {
                                        <option value="@n.NhomTieuChiID" selected="@(tc.NhomTieuChiID == n.NhomTieuChiID ? "selected" : null)">
                                            @n.TenNhom
                                        </option>
                                    }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-tag me-2"></i>
                                Tên tiêu chí
                            </label>
                            <input name="TenTieuChi" value="@tc.TenTieuChi" class="form-control modern-form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-star me-2"></i>
                                Điểm tối đa
                            </label>
                            <input name="DiemToiDa" type="number" value="@tc.DiemToiDa" class="form-control modern-form-control" required />
                        </div>
                    </div>
                    <div class="modal-footer" style="border: none; padding: 1.5rem;">
                        <button class="modern-btn btn-add">
                            <i class="fas fa-save me-2"></i>
                            Lưu
                        </button>
                        <button type="button" class="modern-btn" style="background: #6c757d; color: white;" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Đóng
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert-modern').fadeOut();
        }, 5000);

        // Form validation
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.style.borderColor = '#dc3545';
                        isValid = false;
                    } else {
                        field.style.borderColor = '#f093fb';
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                }
            });
        });

        // Animation for table rows
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('.modern-table tbody tr');
            rows.forEach((row, index) => {
                row.style.animationDelay = `${index * 0.1}s`;
                row.style.animation = 'fadeInUp 0.6s ease forwards';
            });
        });
    </script>
}
