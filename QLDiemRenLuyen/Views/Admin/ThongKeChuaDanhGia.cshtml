@model List<QLDiemRenLuyen.Models.SinhVien>
@{
    ViewData["Title"] = "Thống kê SV chưa đạt / chưa có điểm";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link rel="stylesheet" href="~/css/ThongKeChuaDanhGia.css">

<div class="admin-container">
    <div class="container-fluid">
        <div class="content-card">
            <h1 class="page-title">Thống Kê Sinh Viên Theo Kết Quả Đánh Giá</h1>

            Stats Cards
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(Model?.Count ?? 0)</div>
                        <div class="text-muted">Tổng sinh viên</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(ViewBag.HocKys?.Count ?? 0)</div>
                        <div class="text-muted">Học kỳ</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(ViewBag.Khoas?.Count ?? 0)</div>
                        <div class="text-muted">Khoa</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">@(ViewBag.Lops?.Count ?? 0)</div>
                        <div class="text-muted">Lớp</div>
                    </div>
                </div>
            </div>

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-warning-modern alert-modern">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["Error"]
                </div>
            }

            Filter Form
            <div class="filter-form">
                <form method="get" class="row mb-4" id="filterForm">
                    <div class="col-md-3">
                        <label><i class="fas fa-calendar me-1"></i>Học kỳ</label>
                        <select name="HocKyID" id="HocKyID" class="form-select modern-form-control">
                            <option value="">-- Tất cả --</option>
                            @foreach (var hk in ViewBag.HocKys)
                            {
                                <option value="@hk.HocKyID" selected="@(ViewBag.HocKyID == hk.HocKyID ? "selected" : null)">
                                    @hk.TenHocKy - @hk.NamHoc | @hk.NienKhoa?.TenNienKhoa
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label><i class="fas fa-university me-1"></i>Khoa</label>
                        <select name="KhoaID" id="KhoaID" class="form-select modern-form-control">
                            <option value="">-- Tất cả --</option>
                            @foreach (var khoa in ViewBag.Khoas)
                            {
                                <option value="@khoa.KhoaID" selected="@(ViewBag.KhoaID == khoa.KhoaID ? "selected" : null)">
                                    @khoa.TenKhoa
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label><i class="fas fa-users me-1"></i>Lớp</label>
                        <select name="LopID" id="LopID" class="form-select modern-form-control">
                            <option value="">-- Tất cả lớp --</option>
                            @foreach (var lop in ViewBag.Lops)
                            {
                                <option value="@lop.LopID" selected="@(ViewBag.LopID == lop.LopID ? "selected" : null)">
                                    @lop.TenLop
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label><i class="fas fa-filter me-1"></i>Loại</label>
                        <select name="Loai" class="form-select modern-form-control">
                            <option value="">-- Chọn loại --</option>
                            <option value="ChuaDat" selected="@(ViewBag.Loai == "ChuaDat" ? "selected" : null)">Chưa đạt</option>
                            <option value="ChuaCoDiem" selected="@(ViewBag.Loai == "ChuaCoDiem" ? "selected" : null)">Chưa có điểm</option>
                        </select>
                    </div>
                    <div class="col-12 mt-3">
                        <button type="submit" class="modern-btn btn-filter w-100">
                            <i class="fas fa-filter me-2"></i> Lọc dữ liệu
                        </button>
                    </div>
                </form>
            </div>

            @if ( Model == null || Model.Count == 0 && TempData["Error"] == null)
            {
                <div class="alert alert-success-modern alert-modern text-center">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>✅ Không có sinh viên nào trong danh sách!</h5>
                    <p>Tất cả sinh viên đều đã hoàn thành đánh giá</p>
                </div>
            }
            else if (Model.Count > 0)
            {
                <div class="table-container">
                    <table class="table modern-table" id="statisticsTable">
                        <thead>
                            <tr>
                                <th><i class="fas fa-list-ol me-1"></i>STT</th>
                                <th><i class="fas fa-id-card me-1"></i>Mã SV</th>
                                <th><i class="fas fa-user me-1"></i>Họ tên</th>
                                <th><i class="fas fa-users me-1"></i>Lớp</th>
                                <th><i class="fas fa-star me-1"></i>Điểm</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var sv = Model[i];
                                var ketQua = sv.KetQuaRenLuyen?.FirstOrDefault(kq => kq.HocKyID == ViewBag.HocKyID);
                                <tr>
                                    <td title="STT @(i + 1)">
                                        <span class="badge bg-secondary rounded-pill">@(i + 1)</span>
                                    </td>
                                    <td title="@sv.MaSV">
                                        <span class="badge bg-primary rounded-pill">@sv.MaSV</span>
                                    </td>
                                    <td title="@sv.HoTen">
                                        <div class="text-ellipsis">
                                            <strong>@sv.HoTen</strong>
                                        </div>
                                    </td>
                                    <td title="@sv.Lop?.TenLop">
                                        <span class="badge badge-lop">@sv.Lop?.TenLop</span>
                                    </td>
                                    <td title="Điểm: @(ketQua?.TongDiemHoiDongDuyet?.ToString() ?? "Chưa có")">
                                        @if (ketQua != null && ketQua.TongDiemHoiDongDuyet.HasValue)
                                        {
                                            <span class="badge badge-diem">@ketQua.TongDiemHoiDongDuyet</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-chuaco">Chưa có</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Animation for table rows
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('.modern-table tbody tr');
            rows.forEach((row, index) => {
                row.style.animationDelay = `${index * 0.1}s`;
                row.classList.add('animate__animated', 'animate__fadeInUp');
            });
        });

        // Auto-submit form when filters change
        document.querySelectorAll('#filterForm select').forEach(select => {
            select.addEventListener('change', function() {
                // Optional: Auto-submit on change
                // document.getElementById('filterForm').submit();
            });
        });
    </script>
}
