@model QLDiemRenLuyen.ViewModels.TuDanhGiaViewModel
@{
    ViewData["Title"] = "Duyệt phiếu";
    Layout = "~/Views/Shared/_LayoutGiaoVien.cshtml";
    var nhomTieuChis = Model.NhomTieuChi ?? new();
    var danhGiaChiTiet = Model.ChiTietPhieu ?? new();
}

<h4 class="text-uppercase text-center">GVCN đề xuất điểm rèn luyện</h4>
<h5 class="text-center text-muted">
    Sinh viên: <strong>@ViewBag.SinhVien?.HoTen</strong> |
    Lớp: <strong>@ViewBag.SinhVien?.Lop?.TenLop</strong> |
    Học kỳ: <strong>@ViewBag.HocKy?.TenHocKy - @ViewBag.HocKy?.NamHoc</strong>
</h5>

<form asp-action="DuyetPhieu" method="post" novalidate>
    <input type="hidden" asp-for="PhieuDanhGiaID" />

    @foreach (var nhom in nhomTieuChis)
    {
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <strong>@nhom.TenNhom</strong> (Tối đa: @nhom.DiemToiDa điểm)
            </div>
            <div class="card-body p-3">
                <table class="table table-bordered" data-diem-toi-da="@nhom.DiemToiDa">
                    <thead class="table-light text-center">
                        <tr>
                            <th>Nội dung đánh giá</th>
                            <th width="180px">SV tự đánh giá</th>
                            <th width="200px">GVCN đánh giá</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tc in nhom.TieuChi ?? new())
                        {
                            var ct = danhGiaChiTiet.FirstOrDefault(x => x.TieuChiID == tc.TieuChiID);
                            int diemSV = ct?.DiemTuDanhGia ?? 0;
                            <tr>
                                <td>@tc.TenTieuChi</td>
                                <td class="text-center text-primary fw-bold">@diemSV</td>
                                <td class="text-center">
                                    <input type="number"
                                           name="DiemGiaoVienDeXuat[@tc.TieuChiID]"
                                           class="form-control text-center diem-gv"
                                           value="@((ct?.DiemGiaoVienDeXuat ?? (tc.DiemToiDa < 0 ? 0 : 0)).ToString())"
                                           data-nhom-id="@nhom.NhomTieuChiID"
                                           min="@((tc.DiemToiDa < 0) ? tc.DiemToiDa : 0)"
                                           max="@tc.DiemToiDa"
                                           @(tc.DiemToiDa > 0 ? "required" : "") />
                                </td>
                            </tr>
                        }
                </tbody>
                <tfoot>
                    <tr class="fw-bold text-center">
                        <td class="text-end" colspan="2">Tổng điểm nhóm:</td>
                        <td class="text-success"><span id="tong-nhom-@nhom.NhomTieuChiID">0</span></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
        }

    <div class="row mt-4">
        <div class="col-md-2 text-end">
            <strong>Tổng điểm GVCN:</strong>
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control fw-bold text-center text-success" id="tongDiemGV" readonly value="0" />
        </div>
    </div>

    <div class="mt-4 text-center">
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-paper-plane me-1"></i> Lưu và gửi duyệt lên Hội đồng
        </button>
        <a href="/GiaoVien/DanhSachPhieuDanhGia" class="btn btn-custom-dark btn-lg text-white">
            <i class="fas fa-arrow-left me-2"></i>
            Quay lại
        </a>
    </div>
</form>

@section Scripts {
    <script>
        function tinhTongGVTheoNhom() {
            const nhomTong = {};       // lưu tổng điểm từng nhóm
            const nhomToiDa = {};      // lưu tối đa từng nhóm

            // Quét từng input, nhóm điểm theo NhomID
            document.querySelectorAll(".diem-gv").forEach(input => {
                const val = parseInt(input.value);
                const nhomId = input.getAttribute("data-nhom-id");
                const maxNhom = parseInt(input.closest("table").getAttribute("data-diem-toi-da"));

                if (!isNaN(val) && nhomId) {
                    if (!nhomTong[nhomId]) nhomTong[nhomId] = 0;
                    if (!nhomToiDa[nhomId]) nhomToiDa[nhomId] = maxNhom;

                    nhomTong[nhomId] += val;
                }
            });

            // Gán điểm nhóm (giới hạn theo tối đa)
            let tongTatCa = 0;
            for (const nhomId in nhomTong) {
                const diemNhom = Math.min(nhomTong[nhomId], nhomToiDa[nhomId] || nhomTong[nhomId]);
                const span = document.getElementById("tong-nhom-" + nhomId);
                if (span) span.innerText = diemNhom;
                tongTatCa += diemNhom;
            }

            // Tổng điểm toàn bộ
            document.getElementById("tongDiemGV").value = tongTatCa;
        }

        document.addEventListener("DOMContentLoaded", () => {
            tinhTongGVTheoNhom();
            document.querySelectorAll(".diem-gv").forEach(input => {
                input.addEventListener("input", tinhTongGVTheoNhom);
            });
        });
    </script>
}
