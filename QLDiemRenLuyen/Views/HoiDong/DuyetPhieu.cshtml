@model QLDiemRenLuyen.ViewModels.TuDanhGiaViewModel
@{
    ViewData["Title"] = "Duyệt phiếu";
    Layout = "~/Views/Shared/_LayoutHoiDong.cshtml";

    var nhomTieuChis = Model.NhomTieuChi ?? new();
    var danhGiaChiTiet = Model.ChiTietPhieu ?? new();
}
<h4 class="text-uppercase text-center">HỘI ĐỒNG duyệt điểm rèn luyện</h4>
<h5 class="text-center text-muted">
    Sinh viên: <strong>@ViewBag.SinhVien?.HoTen</strong> |
    Lớp: <strong>@ViewBag.SinhVien?.Lop?.TenLop</strong> |
    Học kỳ: <strong>@ViewBag.HocKy?.TenHocKy - @ViewBag.HocKy?.NamHoc</strong>
</h5>

<form asp-action="DuyetPhieu" method="post" novalidate>
    <input type="hidden" asp-for="PhieuDanhGiaID" />

    @foreach (var nhom in nhomTieuChis)
    {
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <strong>@nhom.TenNhom</strong> (Tối đa: @nhom.DiemToiDa điểm)
            </div>
            <div class="card-body p-3">
                <table class="table table-bordered" data-diem-toi-da="@nhom.DiemToiDa">
                    <thead class="table-light text-center">
                        <tr>
                            <th>Nội dung đánh giá</th>
                            <th width="150px">Tự đánh giá</th>
                            <th width="180px">GVCN đề xuất</th>
                            <th width="180px">Hội đồng duyệt</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tc in nhom.TieuChi ?? new())
                        {
                            var ct = danhGiaChiTiet.FirstOrDefault(x => x.TieuChiID == tc.TieuChiID);
                            <tr>
                                <td>@tc.TenTieuChi</td>
                                <td class="text-center text-primary">@ct?.DiemTuDanhGia</td>
                                <td class="text-center text-warning">@ct?.DiemGiaoVienDeXuat</td>
                                <td class="text-center">
                                    <input type="number"
                                           name="DiemHoiDongDuyet[@tc.TieuChiID]"
                                           class="form-control text-center diem-hd"
                                           value="@((ct?.DiemHoiDongDuyet ?? ct?.DiemGiaoVienDeXuat ?? 0).ToString())"
                                           data-nhom-id="@nhom.NhomTieuChiID"
                                           min="0"
                                           max="@tc.DiemToiDa"
                                           required />
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="fw-bold text-center">
                            <td class="text-end" colspan="3">Tổng điểm nhóm:</td>
                            <td class="text-success"><span id="tong-nhom-@nhom.NhomTieuChiID">0</span></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    }

    <div class="row mt-4">
        <div class="col-md-10 text-end">
            <strong>Tổng điểm Hội đồng:</strong>
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control fw-bold text-center text-success" id="tongDiemHD" readonly value="0" />
        </div>
    </div>

    <div class="mt-4 text-center">
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-paper-plane me-1"></i> Hoàn tất duyệt phiếu
        </button>
        <a href="/HoiDong/DanhSachPhieu" class="btn btn-secondary btn-lg">
            <i class="fas fa-arrow-left me-1"></i> Quay lại
        </a>
    </div>
</form>

@section Scripts {
    <script>
        function tinhTongDiemHoiDong() {
            const nhomTong = {};
            const nhomToiDa = {};
            document.querySelectorAll(".diem-hd").forEach(input => {
                const val = parseInt(input.value);
                const nhomId = input.getAttribute("data-nhom-id");
                const max = parseInt(input.closest("table").getAttribute("data-diem-toi-da"));
                if (!isNaN(val)) {
                    nhomTong[nhomId] = (nhomTong[nhomId] || 0) + val;
                    nhomToiDa[nhomId] = max;
                }
            });

            let tong = 0;
            for (const nhomId in nhomTong) {
                const diem = Math.min(nhomTong[nhomId], nhomToiDa[nhomId]);
                document.getElementById("tong-nhom-" + nhomId).innerText = diem;
                tong += diem;
            }
            document.getElementById("tongDiemHD").value = tong;
        }

        document.addEventListener("DOMContentLoaded", () => {
            tinhTongDiemHoiDong();
            document.querySelectorAll(".diem-hd").forEach(input => {
                input.addEventListener("input", tinhTongDiemHoiDong);
            });
        });
    </script>
}
