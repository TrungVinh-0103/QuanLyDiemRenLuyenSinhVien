@model QLDiemRenLuyen.ViewModels.TuDanhGiaViewModel
@{
    ViewData["Title"] = "Tự đánh giá";
    Layout = "~/Views/Shared/_LayoutSinhVien.cshtml";
    var nhomTieuChis = Model.NhomTieuChi ?? new List<QLDiemRenLuyen.ViewModels.NhomTieuChiViewModel>();
    var hocKy = ViewBag.HocKys as List<HocKy> ?? new List<HocKy>();
}

<link rel="stylesheet" href="/css/TuDanhGia.css" />
<div class="evaluation-container">
    <div class="container">
        <div class="content-card">
            <h1 class="page-title">
                <i class="fas fa-clipboard-check me-3"></i>
                PHIẾU TỰ ĐÁNH GIÁ RÈN LUYỆN
            </h1>

            <!-- Semester Selector -->
            <div class="semester-selector">
                <form method="get" asp-action="TuDanhGia">
                    <label>
                        <i class="fas fa-calendar-alt me-2"></i>
                        Chọn học kỳ đánh giá:
                    </label>
                    <select name="hocKyID" class="modern-select" onchange="this.form.submit()">
                        <option value="">-- Chọn học kỳ --</option>
                        @foreach (var hk in hocKy)
                        {
                            <option value="@hk.HocKyID" selected="@(hk.HocKyID == Model.HocKyID ? "selected" : null)">
                                @hk.TenHocKy - @hk.NamHoc (@hk.NienKhoa?.TenNienKhoa)
                            </option>
                        }
                    </select>
                </form>
            </div>

            <!-- Alerts -->
            @if (TempData["Loi"] != null)
            {
                <div class="alert-modern alert-danger-modern">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["Loi"]
                </div>
            }

            @if (TempData["Success"] != null)
            {
                <div class="alert-modern alert-success-modern">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["Success"]
                </div>
            }

            @if (!nhomTieuChis.Any() || nhomTieuChis.All(n => !n.TieuChi?.Any() ?? true))
            {
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <h5>Không có tiêu chí đánh giá</h5>
                    <p>Vui lòng chọn học kỳ để hiển thị các tiêu chí đánh giá tương ứng.</p>
                </div>
            }
            else
            {
                <form asp-action="TuDanhGia" asp-controller="SinhVien" method="post" enctype="multipart/form-data">
                    <input type="hidden" asp-for="HocKyID" />

                    @foreach (var nhom in nhomTieuChis)
                    {
                        <div class="criteria-group" style="animation-delay: @(nhomTieuChis.IndexOf(nhom) * 0.1)s;">
                            <div class="group-header">
                                <i class="fas fa-list-ul me-2"></i>
                                @nhom.TenNhom
                                <span class="float-end">
                                    <i class="fas fa-star me-1"></i>
                                    Tối đa: @nhom.DiemToiDa điểm
                                </span>
                            </div>
                            <div class="group-body">
                                @if (nhom.TieuChi != null && nhom.TieuChi.Any())
                                {
                                    @foreach (var tieuChi in nhom.TieuChi)
                                    {
                                        bool laTieuChiViPham = tieuChi.DiemToiDa < 0;
                                        <div class="criteria-item">
                                            <label class="criteria-label">
                                                <i class="fas fa-@(laTieuChiViPham ? "exclamation-triangle text-danger" : "check-circle text-success") me-2"></i>
                                                @tieuChi.TenTieuChi
                                                <small class="text-muted d-block mt-1">
                                                    Tối đa: @tieuChi.DiemToiDa @(laTieuChiViPham ? " (Điểm trừ nếu có vi phạm)" : " điểm")
                                                </small>
                                            </label>

                                            <input type="hidden" name="DiemTieuChiList.Index" value="@tieuChi.TieuChiID" />
                                            <input type="hidden" name="DiemTieuChiList[@tieuChi.TieuChiID].TieuChiID" value="@tieuChi.TieuChiID" />
                                            <input type="number"
                                                   name="DiemTieuChiList[@tieuChi.TieuChiID].DiemTuDanhGia"
                                                   class="criteria-input diem-input @(laTieuChiViPham ? "violation" : "")"
                                                   data-nhom="@nhom.NhomTieuChiID"
                                                   min="@(laTieuChiViPham ? -Math.Abs(tieuChi.DiemToiDa) : 0)"
                                                   max="@(laTieuChiViPham ? 0 : tieuChi.DiemToiDa)"
                                                   placeholder="@(laTieuChiViPham ? "Nhập 0 nếu không vi phạm" : "Nhập điểm từ 0 đến " + tieuChi.DiemToiDa)"
                                                   @(laTieuChiViPham ? "" : "required") />
                                        </div>
                                    }

                                    <div class="group-total">
                                        <i class="fas fa-calculator me-2"></i>
                                        <strong>Tổng điểm nhóm:</strong>
                                        <span class="text-primary fw-bold" id="tong-nhom-@nhom.NhomTieuChiID" data-max="@nhom.DiemToiDa">0</span> / @nhom.DiemToiDa điểm
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                                        <p>Không có tiêu chí trong nhóm này.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Total Score Display -->
                    <div class="total-score">
                        <h5 class="mb-3">
                            <i class="fas fa-trophy me-2"></i>
                            TỔNG ĐIỂM ĐÁNH GIÁ
                        </h5>
                        <div class="total-number" id="tongDiemDanhGia">0</div>
                        <small class="text-muted">điểm</small>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane me-2"></i>
                            Gửi phiếu đánh giá
                        </button>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function capNhatDiem() {
            let tongDiem = 0;
            let nhomDiem = {};

            // Lặp qua từng input điểm
            document.querySelectorAll(".diem-input").forEach(input => {
                let diem = parseInt(input.value);
                let nhomId = input.getAttribute("data-nhom");

                if (!isNaN(diem)) {
                    // Cộng điểm nhóm
                    if (!nhomDiem[nhomId]) nhomDiem[nhomId] = 0;
                    nhomDiem[nhomId] += diem;
                }
            });

            // Cập nhật tổng điểm nhóm và cộng tổng
            for (let nhomId in nhomDiem) {
                let span = document.getElementById("tong-nhom-" + nhomId);
                if (span) {
                    let gioiHan = parseInt(span.getAttribute("data-max")) || Infinity;
                    let diemNhom = Math.min(nhomDiem[nhomId], gioiHan);
                    span.innerText = diemNhom;

                    // Thêm hiệu ứng màu sắc
                    if (diemNhom >= gioiHan * 0.8) {
                        span.className = "text-success fw-bold";
                    } else if (diemNhom >= gioiHan * 0.6) {
                        span.className = "text-warning fw-bold";
                    } else {
                        span.className = "text-danger fw-bold";
                    }

                    // Chỉ cộng vào tổng điểm sau khi đã giới hạn
                    tongDiem += diemNhom;
                }
            }

            // Cập nhật tổng điểm toàn bộ
            document.getElementById("tongDiemDanhGia").innerText = tongDiem;
        }

        document.addEventListener("DOMContentLoaded", function () {
            capNhatDiem();

            document.querySelectorAll(".diem-input").forEach(input => {
                input.addEventListener("input", function() {
                    capNhatDiem();

                    // Thêm hiệu ứng visual feedback
                    if (this.value) {
                        this.style.borderColor = "#28a745";
                        this.style.backgroundColor = "#f8fff9";
                    } else {
                        this.style.borderColor = "#e0e0e0";
                        this.style.backgroundColor = "white";
                    }
                });
            });

            // Auto-hide alerts after 5 seconds
            const alerts = document.querySelectorAll('.alert-modern');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-20px)';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
        });
    </script>
}
